/*! natty-fetch.min.js v2.2.3 | MIT License | https://github.com/jias/natty-fetch */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("natty-storage")):"function"==typeof define&&define.amd?define(["natty-storage"],t):e.nattyFetch=t(e.nattyStorage)}(this,function(e){"use strict";function t(e){return e}function r(e){return function(){for(var t=arguments,r=e(t[0],t[1]),n=2,o=t.length;n<o;n++)r=e(r,t[n]);return r}}function n(){return X(9e9*G())}function o(e){return!!e.match(H)}function a(e){return!!e.match(B)}function i(e){return typeof e===V}function s(e){return typeof e===W}function c(e){return typeof e===z}function u(e){return c(e)?e():e}function p(e){return!isNaN(e)&&typeof e===K}function l(e){return typeof e===Q&&e!==C}function f(e){return e!==C&&e===e.window}function d(e){return e!==C&&l(e)&&!f(e)&&Object.getPrototypeOf(e)===Object.prototype}function m(e){var t=0;for(var r in e)e.hasOwnProperty(r)&&t++;return 0===t}function h(e){return M.call(e)===I}function g(e){var t=R.createElement("a");return t.href=e,L.hostname!==t.hostname||L.port!==t.port||L.protocol!==t.protocol}function v(e,t,r){void 0===e&&(e={}),void 0===t&&(t={}),void 0===r&&(r=P);for(var n in t)t.hasOwnProperty(n)&&void 0!==t[n]&&(r===E?h(t[n])?e[n]=[].concat(t[n]):d(t[n])?e[n]=Y({},t[n]):e[n]=t[n]:e[n]=t[n]);return e}function y(e){return!!e&&typeof e.length===K}function j(e,t){var r,n;if(y(e)){for(r=0,n=e.length;r<n;r++)if(t.call(e[r],e[r],r)===!1)return}else for(r in e)if(t.call(e[r],e[r],r)===!1)return}function k(e){var t,r={},n=[];for(t in e)e.hasOwnProperty(t)&&(n.push(t),d(e[t])&&(e[t]=k(e[t])));n.sort();for(var o=0,a=n.length;o<a;o++)r[n[o]]=e[n[o]];return r}function b(e,t,r,n){var o,a=h(t),i=d(t);j(t,function(t,s){o=M.call(t),n&&(s=r?n:n+"["+(i||o==A||o==I?s:"")+"]"),!n&&a?e.add(t.name,t.value):o==I||!r&&o==A?b(e,t,r,s):e.add(s,t)})}function w(e,t){var r=[];return r.add=function(e,t){c(t)&&(t=t()),t==C&&(t=""),r.push(F(e)+"="+F(t))},b(r,e,t),r.join("&").replace(/%20/g,"+")}function S(e){return decodeURIComponent(e.replace(/\+/g," "))}function _(e,t,r,n){r&&(t[i(r)?"_stamp":r]=+new Date);var o=w(t,n);return o?e+(~e.indexOf("?")?"&":"?")+o:e}function q(e){return ee+e}function x(e){e=Y({},pe,e);var t=g(e.url),r=new XMLHttpRequest;ue(r,e),r.open(e.method,_(e.url,Y({},e.useMark?e.mark:{},e.method===ne?e.data:{}),e.urlStamp,e.traditional)),r.withCredentials=i(e.withCredentials)?e.withCredentials:t,ce(r,e);var n,o=e.postDataFormat;n=e.method===ne||e.data===C?C:"FORM"===o?w(e.data,e.traditional):"JSON"===o?JSON.stringify(e.data):e.data,r.send(n);var a=r.abort;return r.abort=function(){r._aborted=!0,a.call(r)},r}function O(e){e=Y({},ve,e);var t,r=e.callbackName=e.callbackName.replace(/\{id\}/,n()),o=e.complete;e.complete=function(){me(t),o()},le[r]=function(t){le[r]=C,e.success(t),e.complete()};var a,i=_(e.url,Y((a={},a[e.flag]=r,a),e.useMark?e.mark:{},e.data),e.urlStamp,e.traditional);return t=ge(i,e),{abort:function(){le[r]=function(){le[r]=C},me(t)}}}e="default"in e?e.default:e;var N="undefined"!=typeof window,R=N?document:null,F=encodeURIComponent,C=null,E=!0,P=!E,T="undefined",U="",M=Object.prototype.toString,I="[object Array]",A="[object Object]",D={dummy:E};D.then=D.catch=function(){return D};var L,J=N&&(!!window.ActiveXObject||"ActiveXObject"in window),G=Math.random,X=Math.floor,H=/^(https?:)?\/\//,B=/^[\.\/]/,V="boolean",W="string",z="function",K="number",Q="object";R&&(L=R.createElement("a"),L.href=location.href);var Y=r(v),$=Object.freeze({hasWindow:N,doc:R,escape:F,NULL:C,TRUE:E,FALSE:P,UNDEFINED:T,EMPTY:U,dummyPromise:D,isIE:J,noop:t,redo:r,makeRandom:n,isAbsoluteUrl:o,isRelativeUrl:a,isBoolean:i,isString:s,isFunction:c,runAsFn:u,isNumber:p,isObject:l,isWindow:f,isPlainObject:d,isEmptyObject:m,isArray:h,isCrossDomain:g,extend:Y,likeArray:y,each:j,sortPlainObjectKey:k,serialize:b,param:w,decodeParam:S,appendQueryString:_}),Z=function(e){var t=this;t.promise=new e(function(e,r){t._resolve=e,t._reject=r})};Z.prototype.resolve=function(e){this._resolve.call(this.promise,e)},Z.prototype.reject=function(e){this._reject.call(this.promise,e)};var ee="_",te={on:function(){var e=this,t=arguments;if("string"==typeof t[0]&&"function"==typeof t[1]){var r=q(t[0]);e[r]=e[r]||[],e[r].push(t[1])}else if("object"==typeof t[0]){var n=t[0];for(var o in n)e.on(o,n[o])}},off:function(e,t){var r=this,e=q(e);if(t){var n=r[e];n.splice(n.indexOf(t),1),r[e].length||delete r[e]}else delete r[e]},fire:function(e,t,r){var n=this,o=n[q(e)];if(!o)return"NO_EVENT";for(var a,i=0;a=o[i];i++)a.apply(r||n,[].concat(t))},hasEvent:function(e){return!!this[q(e)]}},re=T!==typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,ne="GET",oe="script",ae="xml",ie="json",se={"*":"*/*",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript",json:"application/json, text/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},ce=function(e,t){var r={Accept:se[t.accept]};if(g(t.url)||(r["X-Requested-With"]="XMLHttpRequest"),Y(r,t.header),"POST"===t.method){var n=t.postDataFormat,o="FORM"===n?"application/x-www-form-urlencoded; charset=UTF-8":"JSON"===n?"application/json; charset=UTF-8":C;o!==C&&(r["Content-Type"]=o)}for(var a in r)e.setRequestHeader(a,r[a])},ue=function(e,t){e._finished=P;var r=function(){if(!e._finished&&4===e.readyState)if(e.status>=200&&e.status<300||304===e.status){var r=e.responseText;switch(t.accept){case ie:try{r=JSON.parse(r)}catch(e){console.warn("The response can NOT be parsed to JSON object.",r)}break;case oe:(0,eval)(r);break;case ae:r=e.responseXML}t.success(r,e)}else!e._aborted&&t.error(e.status,e)};e.addEventListener("readystatechange",r);var n=function(){e._finished||t.abort(e.status,e)};e.addEventListener("abort",n);var o=function(){e._finished||(e._finished=!0,t.complete(e.status,e),delete e._aborted)};e.addEventListener("loadend",o)},pe={url:"",mark:{},useMark:!0,method:ne,accept:"*",data:null,header:{},withCredentials:C,urlStamp:!0,success:t,error:t,complete:t,abort:t,log:P,traditional:P,postDataFormat:"FORM"};x.fallback=!1,x.supportCORS=re;var le=N?window:C,fe=N?document:C,de="script",me=function(e){e.onerror=C,e.parentNode.removeChild(e),e=C},he=C,ge=function(e,t){var r=fe.createElement(de);return r.src=e,r.async=!0,r.onerror=function(e){le[t.callbackName]=C,t.error(e),t.complete()},he=he||fe.getElementsByTagName("head")[0],he.insertBefore(r,he.firstChild),r},ve={url:"",mark:{},useMark:!0,data:{},urlStamp:!0,success:t,error:t,complete:t,log:!1,flag:"callback",callbackName:"jsonp{id}",traditional:P},ye=function(e){var r=e.api;r.loop=function(e,n,o){if(void 0===n&&(n=t),void 0===o&&(o=t),!e.duration||!p(e.duration))throw new Error("Illegal `duration` value for `startLoop` method.");var a=C,i=function(){clearTimeout(a),a=C,i.looping=P},s=function(){i.looping=E,a=setTimeout(function(){r(e.data).then(n,o),s()},e.duration)};return r(e.data).then(n,o),s(),i}},je=function(e){var r=this,n=e.api,o=n.config;n.soon=function(e,a,i){if(void 0===a&&(a=t),void 0===i&&(i=t),!o.ignoreSelfConcurrent||!o.pending){o.overrideSelfConcurrent&&o._lastRequester&&(o._lastRequester.abort(),delete o._lastRequester);var s=r.makeVars(e),c=function(){r.remoteRequest(s,o).then(function(e){a({fromStorage:P,content:e})}).catch(function(e){i(e)})};n.storageUseable?(s.queryString=m(s.data)?"no-query-string":JSON.stringify(k(s.data)),n.storage.has(s.queryString).then(function(e){e.has&&a({fromStorage:E,content:e.value}),c()})):c()}}};void 0===e&&console.warn("Please install the `natty-storage` script which is required by `natty-fetch`, go on with https://www.npmjs.com/package/natty-storage");var ke=Y,be=u,we=o,Se=a,_e=t,qe=i,xe=h,Oe=c,Ne=k,Re=m,Fe=d,Ce=D,Ee=s,Pe=C,Te=E,Ue=P,Me=U,Ie=N,Ae={data:{},didFetch:_e,fit:_e,header:{},ignoreSelfConcurrent:Ue,jsonp:Ue,log:Ue,method:"GET",mock:Ue,mockUrl:Me,mockUrlPrefix:Me,mockUrlSuffix:Me,process:_e,Promise:Ie?window.Promise:Pe,retry:0,customRequest:Pe,timeout:0,traditional:Ue,url:Me,urlPrefix:Me,urlStamp:Te,urlSuffix:Me,withCredentials:Pe,willFetch:_e,storage:!1,plugins:!1,postDataFormat:"FORM"},De=ke({},Ae),Le=function(e,t,r,n){var o=this;o.contextConfig=r,o._path=e;var a=o.config=o.processAPIOptions(t);o.api=function(e){if(e=e||{},a.ignoreSelfConcurrent&&o.api.pending)return Ce;a.overrideSelfConcurrent&&o.api._requester&&o.api.abort();var t=o.makeVars(e);return 0===a.retry?o.request(t,a):o.tryRequest(t,a)},o.api.contextId=n,o.api._path=e,o.api.pending=Ue,o.api._requester=Pe,o.api.abort=function(){o.api.pending&&o.api._requester&&o.api._requester.abort()},o.api.config=a,o.initStorage();for(var i=xe(a.plugins)?a.plugins:[],s=0,c=i.length;s<c;s++)Oe(i[s])&&i[s].call(o,o)};Le.prototype.makeVars=function(e){var t=this,r=t.config,n={mark:{_api:t._path}};return r.mock&&(n.mark._mock=Te),"FORM"!==r.postDataFormat&&"JSON"!==r.postDataFormat||(e=ke({},be(r.data),be(e))),n.data=e,n},Le.prototype.processAPIOptions=function(e){var t=this,r=[].concat(t.contextConfig.plugins||[],e.plugins||[]),n=ke({},t.contextConfig,e,{plugins:r});return n.mock&&(n.mockUrl=t.getFullUrl(n)),n.url=t.getFullUrl(n),xe(e.jsonp)&&(n.jsonp=qe(e.jsonp[0])?e.jsonp[0]:Ue,n.jsonp&&(n.jsonpFlag=e.jsonp[1],n.jsonpCallbackName=e.jsonp[2])),!n.mock&&n.url.match(/\.jsonp(\?.*)?$/)&&(n.jsonp=Te),n},Le.prototype.initStorage=function(){var t=this,r=t.config,n="GET"===r.method||r.jsonp;if(!n&&r.storage===Te)throw new Error("A `"+r.method+"` request CAN NOT use `storage` which is only for `GET/jsonp` request! Please check the options for `"+t._path+"`");if(r.storage===Te&&(r.storage={type:"variable"}),t.api.storageUseable=Fe(r.storage)&&("GET"===r.method||r.jsonp)&&e.support[r.storage.type],t.api.storageUseable){if("localStorage"===r.storage.type){if(!r.storage.hasOwnProperty("key")||!r.storage.key)throw new Error("`key` is required when `storage.type` is `localStorage`.")}else r.storage.key=r.storage.key||[t.api.contextId,t._path].join("_");t.api.storage=e(ke({},r.storage,{async:Te,tag:[r.storage.tag,r.jsonp?"jsonp":r.method,r.url].join("_")}))}},Le.prototype.request=function(e,t){var r=this;return r.api.storageUseable?(e.queryString=Re(e.data)?"no-query-string":JSON.stringify(Ne(e.data)),r.api.storage.has(e.queryString).then(function(n){return n.has?n.value:r.remoteRequest(e,t)})):r.remoteRequest(e,t)},Le.prototype.getFullUrl=function(e){var t=e.mock?e.mockUrl:e.url;if(!t)return Me;var r=e.mock?"mockUrlPrefix":"urlPrefix",n=e.mock?"mockUrlSuffix":"urlSuffix",o=!e[r]||we(t)||Se(t)?Me:e[r],a=e[n]?e[n]:Me;return o+t+a},Le.prototype.remoteRequest=function(e,t){var r=this;t.willFetch(e,t,"remote"),r.api.pending=Te;var n=new Z(t.Promise);return t.customRequest?r.api._requester=t.customRequest(e,t,n):t.jsonp?r.api._requester=r.sendJSONP(e,t,n):r.api._requester=r.sendAjax(e,t,n),0!==t.timeout&&setTimeout(function(){if(r.api.pending&&r.api._requester){r.api.abort();var e={timeout:Te,message:"Timeout By "+t.timeout+"ms."};n.reject(e),te.fire("g.reject",[e,t]),te.fire(r.api.contextId+".reject",[e,t])}},t.timeout),n.promise},Le.prototype.tryRequest=function(e,t){var r=this;return new t.Promise(function(n,o){var a=0,i=function(){e.mark._retryTime=a,r.request(e,t).then(function(e){n(e),te.fire("g.resolve",[e,t],t),te.fire(r.api.contextId+".resolve",[e,t],t)},function(e){a===t.retry?o(e):(a++,i())})};i()})},Le.prototype.processResponse=function(e,t,r,n){var o=this;if(t.didFetch(e,t),n=t.fit(n,e),n.success){var a=t.process(n.content,e),i=function(){r.resolve(a),te.fire("g.resolve",[a,t],t),te.fire(o.api.contextId+".resolve",[a,t],t)};o.api.storageUseable?o.api.storage.set(e.queryString,a).then(function(){i()}).catch(function(){i()}):i()}else{var s=ke({message:"`success` is false, "+o._path},n.error);r.reject(s),te.fire("g.reject",[s,t]),te.fire(o.api.contextId+".reject",[s,t])}},Le.prototype.sendAjax=function(e,t,r){var n=this,o=t.mock?t.mockUrl:t.url;return x({traditional:t.traditional,urlStamp:t.urlStamp,mark:e.mark,useMark:t.mark,log:t.log,url:o,method:t.method,data:e.data,header:t.header,withCredentials:t.withCredentials,accept:"json",success:function(o){n.processResponse(e,t,r,o)},error:function a(i){var a={status:i,message:"Error(status "+i+") in request for "+e.mark._api+"("+o+")"};r.reject(a),te.fire("g.reject",[a,t]),te.fire(n.api.contextId+".reject",[a,t])},complete:function(){void 0!==e.retryTime&&e.retryTime!==t.retry||(n.api.pending=Ue,n.api._requester=Pe)},postDataFormat:t.postDataFormat})},Le.prototype.sendJSONP=function(e,t,r){var n=this,o=t.mock?t.mockUrl:t.url;return O({traditional:t.traditional,log:t.log,mark:e.mark,useMark:t.mark,url:o,data:e.data,urlStamp:t.urlStamp,flag:t.jsonpFlag,callbackName:t.jsonpCallbackName,success:function(o){n.processResponse(e,t,r,o)},error:function a(){var a={message:"Not accessable JSONP in request for "+e.mark._api+"("+o+")"};r.reject(a),te.fire("g.reject",[a,t]),te.fire(n.api.contextId+".reject",[a,t])},complete:function(){void 0!==e.retryTime&&e.retryTime!==t.retry||(n.api.pending=Ue,n.api._requester=Pe)}})};var Je=function(){var t=0;return function(r,n){Ee(r)?n=n||{}:(n=r||{},r="c"+t++);var o=e({type:"variable",key:r}),a={};a.api=o.get(),a._contextId=r;var i=[].concat(De.plugins||[],n.plugins||[]);return a._config=ke({},De,n,{plugins:i}),a.create=function(e,t){var n=2===arguments.length&&Ee(e);n||(t=e);for(var i in t)o.set(n?e+"."+i:i,new Le(n?e+"."+i:i,be(t[i]),a._config,r).api);a.api=o.get()},a.on=function(e,t){if(Oe(t))return te.on(a._contextId+"."+e,t),a},a}}(),Ge={};return Ge.create=function(e){return new Le("nattyFetch",be(e),Ae,"global").api},ke(Ge,{onlyForModern:!0,version:"2.2.3",_util:$,_event:te,context:Je,ajax:x,jsonp:O,setGlobal:function(e){return De=ke({},Ae,e),this},getGlobal:function(e){return e?De[e]:De},on:function(e,t){if(Oe(t))return te.on("g."+e,t),this},plugin:{loop:ye,soon:je}}),Ge.setGlobal(Ae),Ge});
//# sourceMappingURL=natty-fetch.min.js.map
