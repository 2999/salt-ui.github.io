'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/**
 * Calendar Component for tingle
 * @author wenzhao.fw
 *
 * Copyright 2014-2016, Tingle Team.
 * All rights reserved.
 */

var classnames = require('classnames');
var Formatter = require('uxcore-formatter');
var Layer = require('@ali/tingle-layer');
var i18n = require('./i18n');
var MonthCalendar = require('./MonthCalendar');
var YearCalendar = require('./YearCalendar');
var Day = require('./lib/Day');
var Month = require('./lib/Month');
var Year = require('./lib/Year');
var deepcopy = require('deepcopy');
var deepEqual = require('deep-equal');
var Context = require('@ali/tingle-context');
var prefixClass = Context.prefixClass;

// value 的格式：{startDate: '2016-01-02', startDateType: 'AM', endDate: '2016-01-03', endDateType: 'AM' }

var Calendar = function (_React$Component) {
    _inherits(Calendar, _React$Component);

    function Calendar(props) {
        _classCallCheck(this, Calendar);

        // value 可能是对象，为防止外部直接修改 props.value，造成 componentWillReceiveProps 出现问题
        // 故在此备份一份
        var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Calendar).call(this, props));

        _this.value = deepcopy(props.value);
        _this.state = {
            value: deepcopy(props.value),
            panel: 'day'
        };
        return _this;
    }

    _createClass(Calendar, [{
        key: 'componentWillMount',
        value: function componentWillMount() {
            var t = this;
            t.locale = i18n[t.props.locale];
        }
    }, {
        key: 'componentWillReceiveProps',
        value: function componentWillReceiveProps(nextProps) {
            var t = this;
            if (!deepEqual(nextProps.value, t.value)) {
                t.value = deepcopy(nextProps.value);
                t.setState({
                    value: deepcopy(nextProps.value)
                });
            }
        }
    }, {
        key: 'handleChange',
        value: function handleChange(value) {
            var t = this;
            var panelMap = {
                month: 'day',
                year: 'month'
            };
            var newState = {
                value: value
            };
            if (t.state.panel == 'month' || t.state.panel == 'year') {
                newState['panel'] = panelMap[t.state.panel];
            }
            t.setState(newState);
        }
    }, {
        key: 'handlePanelChange',
        value: function handlePanelChange() {
            var t = this;
            var panel = t.state.panel;

            if (panel == 'day') {
                panel = 'month';
            } else if (panel == 'month') {
                panel = 'year';
            }
            t.setState({
                panel: panel
            });
        }
    }, {
        key: 'handleCanel',
        value: function handleCanel() {
            var t = this;
            t.setState({
                panel: 'day'
            });
            t.props.onCancel();
        }
    }, {
        key: 'handleClear',
        value: function handleClear() {
            var t = this;
            t.setState({
                value: deepcopy(t.props.value)
            });
        }
    }, {
        key: 'handleOk',
        value: function handleOk() {
            var t = this;
            t.props.onOk(deepcopy(t.state.value));
        }
    }, {
        key: 'renderPanel',
        value: function renderPanel() {
            var t = this;
            var _t$state = t.state;
            var value = _t$state.value;
            var panel = _t$state.panel;
            var _t$props = t.props;
            var singleMode = _t$props.singleMode;
            var locale = _t$props.locale;
            var showHalfDay = _t$props.showHalfDay;

            var panelProps = {
                value: value,
                onChange: t.handleChange.bind(t),
                singleMode: singleMode,
                locale: locale,
                showHalfDay: showHalfDay,
                onTitleClick: t.handlePanelChange.bind(t),
                onSelecting: t.props.onSelecting,
                extraClass: t.props.extraClass
            };
            if (panel == 'day') {
                return React.createElement(Day, panelProps);
            } else {
                panelProps['singleMode'] = true;
                if (panel == 'month') {
                    return React.createElement(Month, panelProps);
                } else {
                    return React.createElement(Year, panelProps);
                }
            }
        }
    }, {
        key: 'renderTopPanel',
        value: function renderTopPanel() {
            return React.createElement(
                'div',
                { className: classnames(_defineProperty({}, prefixClass("top-panel"), true)) },
                React.createElement(
                    'span',
                    { className: prefixClass("top-panel-cancel"), onClick: this.handleCanel.bind(this) },
                    this.locale['button']['cancel']
                ),
                React.createElement(
                    'span',
                    { className: prefixClass("top-panel-title") },
                    this.props.topPanelTitle || '选择时间'
                ),
                React.createElement(
                    'span',
                    { className: prefixClass("top-panel-confirm"), onClick: this.handleOk.bind(this) },
                    this.locale['button']['confirm']
                )
            );
        }
    }, {
        key: 'renderBottomPanel',
        value: function renderBottomPanel() {
            var _classnames3;

            var t = this;
            return React.createElement(
                'div',
                { className: classnames(_defineProperty({}, prefixClass("operate"), true)) },
                React.createElement(
                    'span',
                    { className: prefixClass("cancel tap op"), onClick: this.handleCanel.bind(this) },
                    t.locale['button']['cancel']
                ),
                ' ',
                React.createElement(
                    'span',
                    { className: prefixClass("reset"),
                        onClick: this.handleClear.bind(this) },
                    ' ',
                    t.locale['button']['clear'],
                    ' '
                ),
                ' ',
                React.createElement(
                    'span',
                    { className: classnames((_classnames3 = {}, _defineProperty(_classnames3, prefixClass("confirm tap op"), true), _defineProperty(_classnames3, prefixClass('gray'), !t.state.value.startDate), _classnames3)),
                        onClick: this.handleOk.bind(this) },
                    ' ',
                    t.locale['button']['confirm'],
                    ' '
                ),
                ' '
            );
        }
    }, {
        key: 'render',
        value: function render() {
            var _classnames4;

            var t = this;
            var clearButton = '';
            var value = t.state.value;
            var _t$props2 = t.props;
            var visible = _t$props2.visible;
            var className = _t$props2.className;
            var singleMode = _t$props2.singleMode;
            var autoFinish = _t$props2.autoFinish;
            var locale = _t$props2.locale;
            var showHalfDay = _t$props2.showHalfDay;

            // Calculate the height of the current container

            var clientHeight = document.documentElement.clientHeight;
            var height = 352;
            !!t.props.showTopPanel && (height += 44);
            !!t.props.showHalfDay && (height += 120);

            return React.createElement(
                Layer,
                { visible: visible },
                React.createElement(
                    'div',
                    { className: prefixClass("calendar-container"), style: {
                            height: clientHeight,
                            // Scale the view to ensure user can see the whole widget 
                            // on the small screen device
                            transform: height >= clientHeight ? 'scale(' + ((clientHeight / height).toFixed(3) - 0.15) + ')' : ''
                        } },
                    React.createElement(
                        'div',
                        { className: classnames((_classnames4 = {}, _defineProperty(_classnames4, prefixClass("calendar"), true), _defineProperty(_classnames4, className, !!className), _classnames4)), style: {
                                display: visible ? 'block' : 'block',
                                height: height
                            } },
                        t.props.showTopPanel && t.renderTopPanel(),
                        t.renderPanel()
                    )
                )
            );
        }
    }]);

    return Calendar;
}(React.Component);

Calendar.propTypes = {
    className: React.PropTypes.string,
    visible: React.PropTypes.bool, // 是否显示
    calendarCode: React.PropTypes.object, // 后端传来的 code
    value: React.PropTypes.oneOfType([React.PropTypes.string, React.PropTypes.object]), // 默认值
    locale: React.PropTypes.string, // 国际化语言
    singleMode: React.PropTypes.bool, // 是否是单选模式
    onCancel: React.PropTypes.func, // 取消选择时触发的回调
    onOk: React.PropTypes.func, // 返回值时触发的回调
    onSelecting: React.PropTypes.func // 开始选择时的回调
};

Calendar.defaultProps = {
    visible: true,
    locale: 'zh-cn',
    calendarCode: {},
    singleMode: true,
    showHalfDay: false,
    showTopPanel: true,
    value: {
        startDate: new Date().getTime(),
        startDateType: 'FULL',
        endDate: new Date().getTime(),
        endDateType: 'FULL'
    },
    onCancel: function onCancel() {},
    onOk: function onOk() {},
    onSelecting: function onSelecting() {}
};

Calendar.MonthCalendar = MonthCalendar;
Calendar.YearCalendar = YearCalendar;

Calendar.displayName = "Calendar";
module.exports = Calendar;
//# sourceMappingURL=data:application/json;base64,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QSxTQUFTLGFBQVQsR0FBeUIsYUFBekI7QUFDQSxTQUFTLFlBQVQsR0FBd0IsWUFBeEI7O0FBRUEsU0FBUyxXQUFULEdBQXVCLFVBQXZCO0FBQ0EsT0FBTyxPQUFQLEdBQWlCLFFBQWpCIiwiZmlsZSI6IkNhbGVuZGFyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDYWxlbmRhciBDb21wb25lbnQgZm9yIHRpbmdsZVxuICogQGF1dGhvciB3ZW56aGFvLmZ3XG4gKlxuICogQ29weXJpZ2h0IDIwMTQtMjAxNiwgVGluZ2xlIFRlYW0uXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICovXG5cbmxldCBjbGFzc25hbWVzID0gcmVxdWlyZSgnY2xhc3NuYW1lcycpO1xubGV0IEZvcm1hdHRlciA9IHJlcXVpcmUoJ3V4Y29yZS1mb3JtYXR0ZXInKTtcbmxldCBMYXllciA9IHJlcXVpcmUoJ0BhbGkvdGluZ2xlLWxheWVyJyk7XG5sZXQgaTE4biA9IHJlcXVpcmUoJy4vaTE4bicpO1xubGV0IE1vbnRoQ2FsZW5kYXIgPSByZXF1aXJlKCcuL01vbnRoQ2FsZW5kYXInKTtcbmxldCBZZWFyQ2FsZW5kYXIgPSByZXF1aXJlKCcuL1llYXJDYWxlbmRhcicpO1xubGV0IERheSA9IHJlcXVpcmUoJy4vbGliL0RheScpO1xubGV0IE1vbnRoID0gcmVxdWlyZSgnLi9saWIvTW9udGgnKTtcbmxldCBZZWFyID0gcmVxdWlyZSgnLi9saWIvWWVhcicpO1xubGV0IGRlZXBjb3B5ID0gcmVxdWlyZSgnZGVlcGNvcHknKTtcbmxldCBkZWVwRXF1YWwgPSByZXF1aXJlKCdkZWVwLWVxdWFsJyk7XG5sZXQgQ29udGV4dCA9IHJlcXVpcmUoJ0BhbGkvdGluZ2xlLWNvbnRleHQnKTtcbmxldCBwcmVmaXhDbGFzcyA9IENvbnRleHQucHJlZml4Q2xhc3M7XG5cbi8vIHZhbHVlIOeahOagvOW8j++8mntzdGFydERhdGU6ICcyMDE2LTAxLTAyJywgc3RhcnREYXRlVHlwZTogJ0FNJywgZW5kRGF0ZTogJzIwMTYtMDEtMDMnLCBlbmREYXRlVHlwZTogJ0FNJyB9XG5jbGFzcyBDYWxlbmRhciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICAvLyB2YWx1ZSDlj6/og73mmK/lr7nosaHvvIzkuLrpmLLmraLlpJbpg6jnm7TmjqXkv67mlLkgcHJvcHMudmFsdWXvvIzpgKDmiJAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyDlh7rnjrDpl67pophcbiAgICAgICAgLy8g5pWF5Zyo5q2k5aSH5Lu95LiA5Lu9XG4gICAgICAgIHRoaXMudmFsdWUgPSBkZWVwY29weShwcm9wcy52YWx1ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICB2YWx1ZTogZGVlcGNvcHkocHJvcHMudmFsdWUpLFxuICAgICAgICAgICAgcGFuZWw6ICdkYXknXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsTW91bnQoKSB7XG4gICAgICAgIGxldCB0ID0gdGhpcztcbiAgICAgICAgdC5sb2NhbGUgPSBpMThuW3QucHJvcHMubG9jYWxlXTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykge1xuICAgICAgICBsZXQgdCA9IHRoaXM7XG4gICAgICAgIGlmICghZGVlcEVxdWFsKG5leHRQcm9wcy52YWx1ZSwgdC52YWx1ZSkpIHtcbiAgICAgICAgICAgIHQudmFsdWUgPSBkZWVwY29weShuZXh0UHJvcHMudmFsdWUpO1xuICAgICAgICAgICAgdC5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGRlZXBjb3B5KG5leHRQcm9wcy52YWx1ZSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBoYW5kbGVDaGFuZ2UodmFsdWUpIHtcbiAgICAgICAgbGV0IHQgPSB0aGlzO1xuICAgICAgICBsZXQgcGFuZWxNYXAgPSB7XG4gICAgICAgICAgICBtb250aDogJ2RheScsXG4gICAgICAgICAgICB5ZWFyOiAnbW9udGgnXG4gICAgICAgIH07XG4gICAgICAgIGxldCBuZXdTdGF0ZSA9IHtcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICB9O1xuICAgICAgICBpZiAodC5zdGF0ZS5wYW5lbCA9PSAnbW9udGgnIHx8IHQuc3RhdGUucGFuZWwgPT0gJ3llYXInKSB7XG4gICAgICAgICAgICBuZXdTdGF0ZVsncGFuZWwnXSA9IHBhbmVsTWFwW3Quc3RhdGUucGFuZWxdO1xuICAgICAgICB9XG4gICAgICAgIHQuc2V0U3RhdGUobmV3U3RhdGUpO1xuICAgIH1cblxuICAgIGhhbmRsZVBhbmVsQ2hhbmdlKCkge1xuICAgICAgICBsZXQgdCA9IHRoaXM7XG4gICAgICAgIGxldCB7IHBhbmVsIH0gPSB0LnN0YXRlO1xuICAgICAgICBpZiAocGFuZWwgPT0gJ2RheScpIHtcbiAgICAgICAgICAgIHBhbmVsID0gJ21vbnRoJztcbiAgICAgICAgfSBlbHNlIGlmIChwYW5lbCA9PSAnbW9udGgnKSB7XG4gICAgICAgICAgICBwYW5lbCA9ICd5ZWFyJztcbiAgICAgICAgfVxuICAgICAgICB0LnNldFN0YXRlKHtcbiAgICAgICAgICAgIHBhbmVsOiBwYW5lbFxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGhhbmRsZUNhbmVsKCkge1xuICAgICAgICBsZXQgdCA9IHRoaXM7XG4gICAgICAgIHQuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcGFuZWw6ICdkYXknXG4gICAgICAgIH0pXG4gICAgICAgIHQucHJvcHMub25DYW5jZWwoKTtcbiAgICB9XG5cbiAgICBoYW5kbGVDbGVhcigpIHtcbiAgICAgICAgbGV0IHQgPSB0aGlzO1xuICAgICAgICB0LnNldFN0YXRlKHtcbiAgICAgICAgICAgIHZhbHVlOiBkZWVwY29weSh0LnByb3BzLnZhbHVlKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGhhbmRsZU9rKCkge1xuICAgICAgICBsZXQgdCA9IHRoaXM7XG4gICAgICAgIHQucHJvcHMub25PayhkZWVwY29weSh0LnN0YXRlLnZhbHVlKSk7XG4gICAgfVxuICAgIFxuICAgIHJlbmRlclBhbmVsKCkge1xuICAgICAgICBsZXQgdCA9IHRoaXM7XG4gICAgICAgIGxldCB7IHZhbHVlLCBwYW5lbCB9ID0gdC5zdGF0ZTtcbiAgICAgICAgbGV0IHsgc2luZ2xlTW9kZSwgbG9jYWxlLCBzaG93SGFsZkRheSB9ID0gdC5wcm9wcztcbiAgICAgICAgbGV0IHBhbmVsUHJvcHMgPSB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICAgICAgICBvbkNoYW5nZTogdC5oYW5kbGVDaGFuZ2UuYmluZCh0KSxcbiAgICAgICAgICAgIHNpbmdsZU1vZGU6IHNpbmdsZU1vZGUsXG4gICAgICAgICAgICBsb2NhbGU6IGxvY2FsZSxcbiAgICAgICAgICAgIHNob3dIYWxmRGF5OiBzaG93SGFsZkRheSxcbiAgICAgICAgICAgIG9uVGl0bGVDbGljazogdC5oYW5kbGVQYW5lbENoYW5nZS5iaW5kKHQpLFxuICAgICAgICAgICAgb25TZWxlY3Rpbmc6IHQucHJvcHMub25TZWxlY3RpbmcsXG4gICAgICAgICAgICBleHRyYUNsYXNzOiB0LnByb3BzLmV4dHJhQ2xhc3NcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHBhbmVsID09ICdkYXknKSB7XG4gICAgICAgICAgICByZXR1cm4gPERheSB7Li4ucGFuZWxQcm9wc30vPlxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFuZWxQcm9wc1snc2luZ2xlTW9kZSddID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChwYW5lbCA9PSAnbW9udGgnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDxNb250aCB7Li4ucGFuZWxQcm9wc30vPlxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gPFllYXIgey4uLnBhbmVsUHJvcHN9Lz5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJlbmRlclRvcFBhbmVsKCkge1xuICAgICAgICByZXR1cm4gPGRpdiBjbGFzc05hbWU9e2NsYXNzbmFtZXMoe1twcmVmaXhDbGFzcyhcInRvcC1wYW5lbFwiKV06IHRydWV9KX0+XG4gICAgICA8c3BhbiBjbGFzc05hbWU9e3ByZWZpeENsYXNzKFwidG9wLXBhbmVsLWNhbmNlbFwiKX0gb25DbGljaz17dGhpcy5oYW5kbGVDYW5lbC5iaW5kKHRoaXMpfT57dGhpcy5sb2NhbGVbJ2J1dHRvbiddWydjYW5jZWwnXX08L3NwYW4+XG4gICAgICA8c3BhbiBjbGFzc05hbWU9e3ByZWZpeENsYXNzKFwidG9wLXBhbmVsLXRpdGxlXCIpfT57dGhpcy5wcm9wcy50b3BQYW5lbFRpdGxlIHx8ICfpgInmi6nml7bpl7QnfTwvc3Bhbj5cbiAgICAgIDxzcGFuIGNsYXNzTmFtZT17cHJlZml4Q2xhc3MoXCJ0b3AtcGFuZWwtY29uZmlybVwiKX0gb25DbGljaz17dGhpcy5oYW5kbGVPay5iaW5kKHRoaXMpfT57dGhpcy5sb2NhbGVbJ2J1dHRvbiddWydjb25maXJtJ119PC9zcGFuPlxuICAgIDwvZGl2PlxuICAgIH1cblxuICAgIHJlbmRlckJvdHRvbVBhbmVsKCkge1xuICAgICAgICBsZXQgdCA9IHRoaXM7XG4gICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZSA9IHtcbiAgICAgICAgICAgICAgICBjbGFzc25hbWVzKHtcbiAgICAgICAgICAgICAgICAgICAgW3ByZWZpeENsYXNzKFwib3BlcmF0ZVwiKV06IHRydWVcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSA+XG4gICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e3ByZWZpeENsYXNzKFwiY2FuY2VsIHRhcCBvcFwiKX0gb25DbGljaz17dGhpcy5oYW5kbGVDYW5lbC5iaW5kKHRoaXMpfT57dC5sb2NhbGVbJ2J1dHRvbiddWydjYW5jZWwnXX08L3NwYW4+IDwgc3BhbiBjbGFzc05hbWUgPSB7IHByZWZpeENsYXNzKFwicmVzZXRcIikgfVxuICAgICAgICBvbkNsaWNrID0geyB0aGlzLmhhbmRsZUNsZWFyLmJpbmQodGhpcykgfSA+IHsgdC5sb2NhbGVbJ2J1dHRvbiddWydjbGVhciddIH0gPCAvc3Bhbj4gPCBzcGFuIGNsYXNzTmFtZSA9IHtcbiAgICAgICAgY2xhc3NuYW1lcyh7XG4gICAgICAgICAgICBbcHJlZml4Q2xhc3MoXCJjb25maXJtIHRhcCBvcFwiKV06IHRydWUsXG4gICAgICAgICAgICBbcHJlZml4Q2xhc3MoJ2dyYXknKV06ICF0LnN0YXRlLnZhbHVlLnN0YXJ0RGF0ZVxuICAgICAgICB9KVxuICAgIH1cbiAgICBvbkNsaWNrID0geyB0aGlzLmhhbmRsZU9rLmJpbmQodGhpcykgfSA+IHsgdC5sb2NhbGVbJ2J1dHRvbiddWydjb25maXJtJ10gfSA8IC9zcGFuPiA8IC9kaXYgPlxufVxuXG5yZW5kZXIoKSB7XG4gICAgbGV0IHQgPSB0aGlzO1xuICAgIGxldCBjbGVhckJ1dHRvbiA9ICcnO1xuICAgIGxldCB7IHZhbHVlIH0gPSB0LnN0YXRlO1xuICAgIGxldCB7IHZpc2libGUsIGNsYXNzTmFtZSwgc2luZ2xlTW9kZSwgYXV0b0ZpbmlzaCwgbG9jYWxlLCBzaG93SGFsZkRheSB9ID0gdC5wcm9wcztcblxuICAgIC8vIENhbGN1bGF0ZSB0aGUgaGVpZ2h0IG9mIHRoZSBjdXJyZW50IGNvbnRhaW5lclxuICAgIGxldCBjbGllbnRIZWlnaHQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0XG4gICAgbGV0IGhlaWdodCA9IDM1MjtcbiAgICAhIXQucHJvcHMuc2hvd1RvcFBhbmVsICYmIChoZWlnaHQgKz0gNDQpO1xuICAgICEhdC5wcm9wcy5zaG93SGFsZkRheSAmJiAoaGVpZ2h0ICs9IDEyMCk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgICA8TGF5ZXIgdmlzaWJsZT17dmlzaWJsZX0+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtwcmVmaXhDbGFzcyhcImNhbGVuZGFyLWNvbnRhaW5lclwiKX0gc3R5bGU9e3tcbiAgICAgICAgICBoZWlnaHQ6IGNsaWVudEhlaWdodCxcbiAgICAgICAgICAvLyBTY2FsZSB0aGUgdmlldyB0byBlbnN1cmUgdXNlciBjYW4gc2VlIHRoZSB3aG9sZSB3aWRnZXQgXG4gICAgICAgICAgLy8gb24gdGhlIHNtYWxsIHNjcmVlbiBkZXZpY2VcbiAgICAgICAgICB0cmFuc2Zvcm06IGhlaWdodCA+PSBjbGllbnRIZWlnaHQgPyAnc2NhbGUoJyArICgoY2xpZW50SGVpZ2h0IC8gaGVpZ2h0KS50b0ZpeGVkKDMpIC0gMC4xNSApKyAnKScgOiAnJ1xuICAgICAgICB9fT5cbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NuYW1lcyh7XG4gICAgICAgICAgICBbcHJlZml4Q2xhc3MoXCJjYWxlbmRhclwiKV06IHRydWUsXG4gICAgICAgICAgICBbY2xhc3NOYW1lXTogISFjbGFzc05hbWVcbiAgICAgICAgICB9KX0gc3R5bGU9e3tcbiAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiB2aXNpYmxlID8gJ2Jsb2NrJyA6ICdibG9jaycsXG4gICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHRcbiAgICAgICAgICAgICAgICAgIH19PlxuICAgICAgICAgICAge3QucHJvcHMuc2hvd1RvcFBhbmVsICYmIHQucmVuZGVyVG9wUGFuZWwoKX1cbiAgICAgICAgICAgIHt0LnJlbmRlclBhbmVsKCl9XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9MYXllcj5cbiAgICApO1xufVxuXG59XG5cblxuQ2FsZW5kYXIucHJvcFR5cGVzID0ge1xuICAgIGNsYXNzTmFtZTogUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICB2aXNpYmxlOiBSZWFjdC5Qcm9wVHlwZXMuYm9vbCwgLy8g5piv5ZCm5pi+56S6XG4gICAgY2FsZW5kYXJDb2RlOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LCAvLyDlkI7nq6/kvKDmnaXnmoQgY29kZVxuICAgIHZhbHVlOiBSZWFjdC5Qcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICAgICAgUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgICAgUmVhY3QuUHJvcFR5cGVzLm9iamVjdFxuICAgIF0pLCAvLyDpu5jorqTlgLxcbiAgICBsb2NhbGU6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsIC8vIOWbvemZheWMluivreiogFxuICAgIHNpbmdsZU1vZGU6IFJlYWN0LlByb3BUeXBlcy5ib29sLCAvLyDmmK/lkKbmmK/ljZXpgInmqKHlvI9cbiAgICBvbkNhbmNlbDogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsIC8vIOWPlua2iOmAieaLqeaXtuinpuWPkeeahOWbnuiwg1xuICAgIG9uT2s6IFJlYWN0LlByb3BUeXBlcy5mdW5jLCAvLyDov5Tlm57lgLzml7bop6blj5HnmoTlm57osINcbiAgICBvblNlbGVjdGluZzogUmVhY3QuUHJvcFR5cGVzLmZ1bmMgLy8g5byA5aeL6YCJ5oup5pe255qE5Zue6LCDXG59XG5cbkNhbGVuZGFyLmRlZmF1bHRQcm9wcyA9IHtcbiAgICB2aXNpYmxlOiB0cnVlLFxuICAgIGxvY2FsZTogJ3poLWNuJyxcbiAgICBjYWxlbmRhckNvZGU6IHt9LFxuICAgIHNpbmdsZU1vZGU6IHRydWUsXG4gICAgc2hvd0hhbGZEYXk6IGZhbHNlLFxuICAgIHNob3dUb3BQYW5lbDogdHJ1ZSxcbiAgICB2YWx1ZToge1xuICAgICAgICBzdGFydERhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxuICAgICAgICBzdGFydERhdGVUeXBlOiAnRlVMTCcsXG4gICAgICAgIGVuZERhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxuICAgICAgICBlbmREYXRlVHlwZTogJ0ZVTEwnXG4gICAgfSxcbiAgICBvbkNhbmNlbDogKCkgPT4ge30sXG4gICAgb25PazogKCkgPT4ge30sXG4gICAgb25TZWxlY3Rpbmc6KCk9Pnt9XG59XG5cblxuQ2FsZW5kYXIuTW9udGhDYWxlbmRhciA9IE1vbnRoQ2FsZW5kYXI7XG5DYWxlbmRhci5ZZWFyQ2FsZW5kYXIgPSBZZWFyQ2FsZW5kYXI7XG5cbkNhbGVuZGFyLmRpc3BsYXlOYW1lID0gXCJDYWxlbmRhclwiO1xubW9kdWxlLmV4cG9ydHMgPSBDYWxlbmRhcjtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
